/*
========================================================================================
    Test Configuration
========================================================================================
    Minimal resource configuration for testing the pipeline with small datasets

    This profile:
    - Uses minimal resources suitable for CI/CD or quick testing
    - Overrides process-specific resources from base.config
    - Points to test data (to be added in Phase 2+)
    - Completes quickly on small datasets (<30 minutes)

    Usage:
      nextflow run main.nf -profile test,singularity

    Note: Test profile can be combined with local or slurm executor profiles
========================================================================================
*/

/*
========================================================================================
    TEST PARAMETERS
========================================================================================
*/

params {
    /*
     * Test Data Paths
     * TODO: Add test data in Phase 2+
     *
     * For now, these are placeholder paths
     * In Phase 2+, you'll need to either:
     * 1. Add small test datasets to tests/data/
     * 2. Generate synthetic test data
     * 3. Subsample existing validated data
     */
    input  = './tests/data/samplesheet_test.csv'
    outdir = './tests/results'

    /*
     * Reduced Resource Limits
     * Suitable for testing on laptops or small VMs
     * These override the defaults in nextflow.config
     */
    max_cpus   = 2
    max_memory = '6.GB'
    max_time   = '1.h'

    /*
     * Test Assembly Parameters
     * Use smaller values appropriate for test data
     */
    genome_size             = '3m'
    min_read_length         = 1000     // Lower for test data
    filtlong_keep_percent   = 90       // Keep more reads for small test set
}

/*
========================================================================================
    PROCESS RESOURCE OVERRIDES
========================================================================================
    Override all process resources with minimal values for testing
    These override the settings in conf/base.config
*/

process {
    /*
     * Light Processes
     * QC and reporting tools with low resource requirements
     */
    withName: 'FASTP|PORECHOP_ABI|FILTLONG|MULTIQC|QUAST' {
        cpus   = 2
        memory = 4.GB
        time   = 30.m
    }

    /*
     * Heavy Processes
     * Assembly and assessment tools - still use minimal resources for testing
     */
    withName: 'FLYE|UNICYCLER|UNICYCLER_WITH_FLYE|CHECKM2' {
        cpus   = 2
        memory = 6.GB
        time   = 1.h
    }

    /*
     * Error Handling for Tests
     * Fail immediately on any error during testing
     * Don't retry with more resources
     */
    errorStrategy = 'finish'
    maxRetries    = 0
}

/*
========================================================================================
    EXECUTOR SETTINGS
========================================================================================
*/

executor {
    /*
     * For test profile, run processes one at a time for predictable behavior
     * This makes it easier to debug issues
     */
    queueSize = 1
}

/*
========================================================================================
    SINGULARITY SETTINGS
========================================================================================
*/

singularity {
    enabled    = true
    autoMounts = true
    cacheDir   = params.singularity_cachedir
}

/*
========================================================================================
    NOTES FOR TESTING
========================================================================================

    1. Test Data Requirements (to be added in Phase 2+):
       - Small bacterial genome dataset (e.g., E. coli or Listeria)
       - Subsampled to ~10x Illumina coverage and 20x Nanopore coverage
       - Should complete full pipeline in <30 minutes
       - Illumina: ~10,000 paired reads (20,000 total)
       - Nanopore: ~500 reads

    2. Generating Test Data:
       If you have existing validated data, subsample it:

       # Subsample Illumina reads
       seqtk sample -s100 full_R1.fastq.gz 10000 | gzip > test_R1.fastq.gz
       seqtk sample -s100 full_R2.fastq.gz 10000 | gzip > test_R2.fastq.gz

       # Subsample Nanopore reads
       seqtk sample -s100 full_nanopore.fastq.gz 500 | gzip > test_nanopore.fastq.gz

    3. Creating Test Samplesheet:
       Create tests/data/samplesheet_test.csv:

       sample,nanopore,illumina_1,illumina_2
       test_sample,tests/data/test_nanopore.fastq.gz,tests/data/test_R1.fastq.gz,tests/data/test_R2.fastq.gz

    4. Running Tests:
       # Basic test
       nextflow run main.nf -profile test,singularity

       # Test with local executor explicitly
       nextflow run main.nf -profile test,singularity,local

       # Test specific module
       nextflow run tests/modules/fastp/test_fastp.nf -profile test,singularity

    5. Expected Test Results:
       - Pipeline should complete without errors
       - Assembly should produce a valid FASTA file
       - MultiQC report should be generated
       - All processes should complete within time limits

    6. Continuous Integration:
       This profile is designed for CI/CD systems like GitHub Actions:
       - Minimal resource requirements
       - Fast execution
       - Deterministic behavior (no retries)

    7. Debugging Failed Tests:
       - Check work directory: ls -la work/
       - Examine process logs: cat work/<hash>/.command.log
       - Check process script: cat work/<hash>/.command.sh
       - Use -resume to restart after fixing issues

========================================================================================
*/
