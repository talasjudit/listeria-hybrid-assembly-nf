/*
========================================================================================
    Test Configuration
========================================================================================
    Resource configuration for testing the pipeline

    This profile:
    - Provides moderate resources for testing with real data
    - Overrides process-specific resources from base.config
    - Combines with executor profiles: -profile test,qib or -profile test,local

    Usage:
      nextflow run main.nf -profile test,qib     # QIB HPC
      nextflow run main.nf -profile test,local   # Local machine
========================================================================================
*/

/*
========================================================================================
    TEST PARAMETERS
========================================================================================
*/

params {
    /*
     * Test Data Paths
     */
    input  = './tests/data/samplesheet_test_abs.csv'
    outdir = './results_test'

    /*
     * Reduced Resource Limits
     * Suitable for testing on laptops or small VMs
     * These override the defaults in nextflow.config
     */
    max_cpus   = 8
    max_memory = '16.GB'
    max_time   = '24.h'

    /*
     * Test Assembly Parameters
     * Use smaller values appropriate for test data
     */
    genome_size             = '3m'
    min_read_length         = 1000     // Lower for test data
    filtlong_keep_percent   = 90       // Keep more reads for small test set
}

/*
========================================================================================
    PROCESS RESOURCE OVERRIDES
========================================================================================
    Override all process resources with minimal values for testing
    These override the settings in conf/base.config
*/

process {
    /*
     * Light Processes
     * QC and reporting tools - increased for real data testing
     * Time limit: 2h (qib queue limit)
     */
    withName: 'FASTP|PORECHOP_ABI|FILTLONG|MULTIQC|QUAST' {
        cpus   = 4
        memory = 8.GB
        time   = 2.h
    }

    /*
     * Heavy Processes
     * Assembly and assessment tools - need more resources for real data
     * Time limit: 24h (medium queue)
     */
    withName: 'FLYE|UNICYCLER|UNICYCLER_WITH_FLYE|CHECKM2' {
        cpus   = 8
        memory = 16.GB
        time   = 24.h
    }

    /*
     * Error Handling for Tests
     * Fail immediately on any error during testing
     * Don't retry with more resources
     */
    errorStrategy = 'finish'
    maxRetries    = 0
}

/*
========================================================================================
    EXECUTOR SETTINGS
========================================================================================
*/

executor {
    /*
     * For test profile, run processes one at a time for predictable behavior
     * This makes it easier to debug issues
     */
    queueSize = 1
}

/*
========================================================================================
    SINGULARITY SETTINGS
========================================================================================
*/

singularity {
    enabled    = true
    autoMounts = true
    cacheDir   = params.singularity_cachedir
}

/*
========================================================================================
    NOTES FOR TESTING
========================================================================================

    1. Running Tests:
       # QIB HPC
       nextflow run main.nf -profile test,qib

       # Local machine
       nextflow run main.nf -profile test,local

    2. Expected Results:
       - Pipeline should complete without errors
       - Assembly should produce a valid FASTA file
       - MultiQC report should be generated

    3. Debugging Failed Tests:
       - Check work directory: ls -la work/
       - Examine process logs: cat work/<hash>/.command.log
       - Check process script: cat work/<hash>/.command.sh
       - Use -resume to restart after fixing issues

========================================================================================
*/
