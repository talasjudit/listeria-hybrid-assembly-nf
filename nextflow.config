/*
========================================================================================
    Hybrid Bacterial Genome Assembly Pipeline - Nextflow Configuration
========================================================================================
    Github: https://github.com/talasjudit/listeria-hybrid-nf
----------------------------------------------------------------------------------------
*/

/*
========================================================================================
    PLUGINS
========================================================================================
    Using nf-schema for parameter and samplesheet validation
    Plugin is cached during installation workflow (workflows/install.nf)
    This allows the pipeline to run on compute nodes without internet access
*/

plugins {
    id 'nf-schema@2.0.0'
}

/*
========================================================================================
    PARAMETERS
========================================================================================
*/

params {
    /*
     * Input/Output Options
     * These are the only REQUIRED parameters for running the pipeline
     */
    input                        = null    // Path to samplesheet CSV file (REQUIRED)
    outdir                       = 'results'
    tracedir                     = "${params.outdir}/pipeline_info"

    /*
     * Container Settings
     * Configure Singularity container handling
     */
    singularity_cachedir         = "${projectDir}/singularity_cache"
    singularity_pull_docker_container = false

    /*
     * Assembly Strategy
     * Control whether to run Flye assembly before Unicycler
     *
     * use_flye = false (default): Standard Unicycler hybrid assembly
     * use_flye = true: Run Flye first, then Unicycler with existing assembly
     */
    use_flye                     = false
    genome_size                  = '3m'    // Expected genome size for Flye (e.g., '3m' for 3 megabases)

    /*
     * QC Thresholds
     * These thresholds generate warnings but do not stop the pipeline
     * Adjust based on your specific requirements
     */
    min_coverage                 = 30      // Minimum Illumina coverage (warning threshold)
    max_coverage                 = 40      // Target Illumina coverage for downsampling
    min_read_length              = 6000    // Minimum Nanopore read length for Filtlong
    filtlong_keep_percent        = 95      // Keep top 95% of best quality reads

    /*
     * Resource Limits
     * Maximum resources that can be requested by any single process
     * These can be overridden on the command line or in custom config files
     */
    max_cpus                     = 12
    max_memory                   = '128.GB'
    max_time                     = '24.h'

    /*
     * MultiQC Options
     * Customize the final aggregated QC report
     */
    multiqc_title                = 'Hybrid Assembly Report'

    /*
     * Validation Options
     * nf-schema plugin settings
     */
    validationSchemaIgnoreParams = 'genomes,igenomes_base'
    validationShowHiddenParams   = false
    validate_params              = true

    /*
     * Boilerplate Options
     */
    help                         = false
    version                      = false
}

/*
========================================================================================
    PROFILES
========================================================================================
    Profiles combine configuration files for different execution environments

    Usage:
      nextflow run main.nf -profile singularity,slurm
      nextflow run main.nf -profile singularity,local
      nextflow run main.nf -profile test
*/

profiles {
    /*
     * Singularity Profile
     * Enable Singularity container execution
     * This should be combined with an executor profile (slurm/local/test)
     */
    singularity {
        singularity.enabled      = true
        singularity.autoMounts   = true
        singularity.cacheDir     = params.singularity_cachedir
    }

    /*
     * SLURM Profile
     * Configure for HPC execution with SLURM scheduler
     * Includes base resource allocations and SLURM-specific settings
     */
    slurm {
        includeConfig 'conf/base.config'
        includeConfig 'conf/slurm.config'
    }

    /*
     * Local Profile
     * Configure for local workstation execution
     * Uses local executor with limited parallelism
     */
    local {
        includeConfig 'conf/base.config'
        includeConfig 'conf/local.config'
    }

    /*
     * Test Profile
     * Minimal resources for testing with small datasets
     * Includes test data paths and reduced resource allocations
     */
    test {
        includeConfig 'conf/base.config'
        includeConfig 'conf/test.config'
    }
}

/*
========================================================================================
    EXECUTION REPORTS
========================================================================================
    Nextflow automatically generates execution reports and trace files
    These help with debugging, optimization, and documentation
*/

timeline {
    enabled                      = true
    file                         = "${params.tracedir}/execution_timeline.html"
    overwrite                    = true
}

report {
    enabled                      = true
    file                         = "${params.tracedir}/execution_report.html"
    overwrite                    = true
}

trace {
    enabled                      = true
    file                         = "${params.tracedir}/execution_trace.txt"
    overwrite                    = true
}

dag {
    enabled                      = true
    file                         = "${params.tracedir}/pipeline_dag.svg"
    overwrite                    = true
}

/*
========================================================================================
    MANIFEST
========================================================================================
    Metadata about the pipeline
*/

manifest {
    name                         = 'listeria-hybrid-nf'
    author                       = 'Your Name'
    homePage                     = 'https://github.com/yourusername/listeria-hybrid-nf'
    description                  = 'Hybrid bacterial genome assembly pipeline using Illumina and Nanopore data'
    mainScript                   = 'main.nf'
    nextflowVersion              = '>=23.04.0'
    version                      = '1.0.0dev'
}

/*
========================================================================================
    NEXTFLOW OPTIONS
========================================================================================
*/

// Ensure DSL2 syntax
nextflow.enable.dsl              = 2

// Fail fast if any process fails (rather than trying to continue)
// This ensures you catch errors early
workflow.failOnError             = false
